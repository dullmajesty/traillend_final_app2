{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="history-logs">
  <h2>Transaction History</h2>
  <p>Total Transactions: {{ transactions|length }}</p>

  <!-- Filters -->
  <div class="filters">
    <input type="text" id="searchBox" placeholder="Search transaction, user, or item">

    <select id="statusFilter">
      <option value="">All statuses</option>
      <option value="approved">Approved</option>
      <option value="borrowed">Borrowed</option>
      <option value="returned">Returned</option>
      <option value="declined">Declined</option>
    </select>

    <label>From
      <input type="date" id="fromDate">
    </label>

    <label>To
      <input type="date" id="toDate">
    </label>

    <select id="rowsPerPage">
      <option value="10">10 rows</option>
      <option value="25">25 rows</option>
      <option value="50">50 rows</option>
    </select>
  </div>

  <!-- Table -->
  <div class="table-wrapper">
    <table class="history-table">
      <thead>
        <tr>
          <th>Transaction ID</th>
          <th>User Name</th>
          <th>Item Name</th>
          <th>Date &amp; Time Receive</th>
          <th>Date &amp; Time Returned</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for t in transactions %}
        <tr>
          <td class="txid">{{ t.transaction_id }}</td>
          <td class="user">{{ t.user_name }}</td>
          <td class="item">{{ t.item_name }}</td>

          {# If these are datetimes, the date filter outputs "" for None, so default works #}
          <td class="receive">
            {{ t.date_receive|date:"Y-m-d H:i"|default:"—" }}
          </td>
          <td class="returned">
            {{ t.date_returned|date:"Y-m-d H:i"|default:"—" }}
          </td>

          <td class="status">
            <span class="badge badge-{{ t.status|lower }}">{{ t.status|capfirst }}</span>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" style="text-align:center;color:#6b7280;">No transactions found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<style>
.history-logs { font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 20px; }
.filters { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; align-items: center; }
.filters input, .filters select { padding: 6px 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; background: #fff; }
.table-wrapper { overflow-x: auto; border-radius: 6px; border: 1px solid #e5e7eb; background: #fff; }
.history-table { width: 100%; border-collapse: collapse; font-size: 14px; }
.history-table th { text-align: left; padding: 10px; background: #f9fafb; border-bottom: 1px solid #e5e7eb; font-weight: 600; color: #111827; }
.history-table td { padding: 10px; border-bottom: 1px solid #e5e7eb; color: #111827; }
.history-table tr:hover { background: #f3f4f6; }

.badge { padding: 2px 8px; border-radius: 999px; font-size: 12px; font-weight: 600; display: inline-block; }
.badge-approved { background:#e0f2fe; color:#0369a1; }
.badge-borrowed { background:#fff7ed; color:#9a3412; }
.badge-returned { background:#ecfdf5; color:#065f46; }
.badge-declined { background:#fee2e2; color:#991b1b; }

/* Optional: responsive labels on small screens */
@media (max-width: 640px) {
  .filters { gap: 6px; }
  .history-table th, .history-table td { padding: 8px; }
}
</style>

<script>
/* Tiny client-side filtering + simple "rows per page" limiter */
(function(){
  const rows = Array.from(document.querySelectorAll('.history-table tbody tr'))
    .filter(tr => tr.querySelectorAll('td').length >= 6); // ignore "empty" row

  const searchBox = document.getElementById('searchBox');
  const statusFilter = document.getElementById('statusFilter');
  const fromDate = document.getElementById('fromDate');
  const toDate = document.getElementById('toDate');
  const rowsPerPage = document.getElementById('rowsPerPage');

  function toDate(s) {
    // expects "YYYY-mm-dd HH:MM" or "—"
    if (!s || s === '—') return null;
    // make it ISO-ish for Date parsing
    return new Date(s.replace(' ', 'T'));
  }

  function apply() {
    const q = (searchBox.value || '').toLowerCase().trim();
    const status = (statusFilter.value || '').toLowerCase();
    const from = fromDate.value ? new Date(fromDate.value) : null;
    const to = toDate.value ? new Date(toDate.value) : null;
    const limit = parseInt(rowsPerPage.value || '10', 10);

    let shown = 0;
    rows.forEach(tr => {
      const txId = tr.querySelector('.txid')?.textContent.toLowerCase() || '';
      const user = tr.querySelector('.user')?.textContent.toLowerCase() || '';
      const item = tr.querySelector('.item')?.textContent.toLowerCase() || '';
      const receiveTxt = tr.querySelector('.receive')?.textContent.trim() || '—';
      const stxt = tr.querySelector('.status')?.textContent.toLowerCase() || '';

      const matchesQ = !q || txId.includes(q) || user.includes(q) || item.includes(q);
      const matchesStatus = !status || stxt.includes(status);

      let matchesDate = true;
      if (from || to) {
        const d = toDate(receiveTxt); // using date_receive as the index date
        if (from && (!d || d < from)) matchesDate = false;
        if (to) {
          // include the end day fully
          const end = new Date(to); end.setDate(end.getDate() + 1);
          if (!d || d >= end) matchesDate = false;
        }
      }

      const visible = matchesQ && matchesStatus && matchesDate && shown < limit;
      tr.style.display = visible ? '' : 'none';
      if (visible) shown++;
    });
  }

  [searchBox, statusFilter, fromDate, toDate, rowsPerPage].forEach(el => {
    if (el) {
      el.addEventListener('input', apply);
      el.addEventListener('change', apply);
    }
  });

  apply();
})();
</script>

<style>
.history-logs {
    font-family: "Inter", sans-serif;
    padding: 20px;
}

.filters {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 15px;
    align-items: center;
}

.filters input,
.filters select {
    padding: 6px 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
}

.table-wrapper {
    overflow-x: auto;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
}

.history-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

.history-table th {
    text-align: left;
    padding: 10px;
    background: #f9fafb;
    border-bottom: 1px solid #e5e7eb;
    font-weight: 600;
}

.history-table td {
    padding: 10px;
    border-bottom: 1px solid #e5e7eb;
}

.history-table tr:hover {
    background: #f3f4f6;
}
</style>
{% endblock %}
