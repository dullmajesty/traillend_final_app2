{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TrailLend Dashboard</title>

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <link rel="stylesheet" href="{% static 'css/style.css' %}">

</head>

<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">
      <img src="{% static 'TRAILLEND-ICON.png' %}" alt="TRAILLEND-ICON" class="avatar"/>
      <span>TrailLend</span>
    </div>
    <div class="header-title">Barangay Kauswagan - General Service Office</div>

    
    <div class="notif-bell" onclick="togglePendingPanel()">
      <i class="fa-solid fa-bell"></i>
      <span id="notifCount" class="notif-badge" style="display:none;">0</span>
    </div>

  </header>

  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <p class="menu-label">MENU</p>

      <a href="{% url 'dashboard' %}" class="{% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
        <i class="fa-solid fa-gauge"></i> Dashboard
      </a>

      <a href="{% url 'inventory' %}" class="{% if request.resolver_match.url_name == 'inventory' %}active{% endif %}">
        <i class="fas fa-box"></i> Inventory
      </a>

      <a href="{% url 'verification' %}" class="{% if request.resolver_match.url_name == 'verification' %}active{% endif %}">
        <i class="fa-solid fa-check-circle"></i> Verification
      </a>

      <a href="{% url 'transaction_log' %}" class="{% if request.resolver_match.url_name == 'transaction_log' %}active{% endif %}">
        <i class="fa-solid fa-clock-rotate-left"></i> Transaction Log
      </a>

      <a href="{% url 'damage_report' %}" class="{% if request.resolver_match.url_name == 'damage_report' %}active{% endif %}">
        <i class="fa-solid fa-file-lines"></i> Damage Report
      </a>

      <a href="{% url 'statistics' %}" class="{% if request.resolver_match.url_name == 'statistics' %}active{% endif %}">
        <i class="fa-solid fa-chart-bar"></i> Statistics
      </a>

      <a href="{% url 'list_of_users' %}" class="{% if request.resolver_match.url_name == 'list_of_users' %}active{% endif %}">
        <i class="fa-solid fa-users"></i> List of Users
      </a>

      <a href="{% url 'change_pass' %}" class="{% if request.resolver_match.url_name == 'change_pass' %}active{% endif %}">
        <i class="fa-solid fa-key"></i> Change Pass
      </a>

      <a href="{% url 'logout' %}">
        <i class="fa-solid fa-right-from-bracket"></i> Log out
      </a>
    </aside>

    <!-- Main content -->
    <main class="content {% if request.resolver_match.url_name != 'dashboard' %}fullwidth{% endif %}">
      {% block content %}{% endblock %}
    </main>

    <!-- Right Pending Panel -->
    {% if request.resolver_match.url_name == 'dashboard' %}
      <!-- Right Pending Panel (Dashboard only) -->
      <div class="pending-container">
        <aside id="pendingPanel" class="side-panel">
          <h3>Pending Requests</h3>
          <ul id="pendingList">
            <li class="pending-item">Loading…</li>
          </ul>
        </aside>
      </div>
    {% endif %}

  <!-- ======= MODALS ======= -->
  <div id="reservationModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6);
        justify-content:center; align-items:center; z-index:2000;">
    <div style="background:#fff; padding:20px; border-radius:10px; width:420px; max-height:90vh; overflow-y:auto;">
      <h3 id="modalTitle"></h3>
      <p><strong>Priority:</strong> <span id="modalPriority"></span></p>
      <p><strong>Borrower:</strong> <span id="modalBorrower"></span></p>
      <p><strong>Quantity:</strong> <span id="modalQty"></span></p>
      <p><strong>Date:</strong> <span id="modalDate"></span></p>
      <p><strong>Message:</strong> <span id="modalMessage"></span></p>
      <p><strong>Contact:</strong> <span id="modalContact"></span></p>
      <p><strong>Status:</strong> <span id="modalStatus"></span></p>

      <div style="display:flex;gap:10px;margin:10px 0;">
        <img id="modalLetter" src="" alt="Letter"
             style="width:100px;height:100px;object-fit:cover;border-radius:6px;cursor:pointer;">
        <img id="modalID" src="" alt="ID"
             style="width:100px;height:100px;object-fit:cover;border-radius:6px;cursor:pointer;">
      </div>

      <div style="margin-top:15px; display:flex; justify-content:space-between;">
        <button id="approveBtn" style="background:#2ecc71;color:#fff;padding:10px 16px;border:none;border-radius:6px;">Approve</button>
        <button id="declineBtn" style="background:#e74c3c;color:#fff;padding:10px 16px;border:none;border-radius:6px;">Decline</button>
        <button id="closeModal" style="background:#ccc;color:#000;padding:10px 16px;border:none;border-radius:6px;">Close</button>
      </div>
    </div>
  </div>

  <!-- Decline Reason Modal -->
  <div id="declineModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6);
        justify-content:center; align-items:center; z-index:3000;">
    <div style="background:#fff; padding:20px; border-radius:10px; width:400px;">
      <h3>Reason for Decline</h3>
      <textarea id="declineReason" style="width:100%;height:100px;padding:10px;border-radius:6px;border:1px solid #ccc;resize:none;"></textarea>
      <div style="margin-top:15px;display:flex;justify-content:flex-end;gap:10px;">
        <button id="cancelDecline" style="background:#ccc;padding:8px 12px;border:none;border-radius:6px;">Cancel</button>
        <button id="submitDecline" style="background:#e74c3c;color:#fff;padding:8px 12px;border:none;border-radius:6px;">Submit</button>
      </div>
    </div>
  </div>

  <!-- Image Viewer -->
  <div id="imageViewer" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9);
        justify-content:center; align-items:center; z-index:4000;">
    <img id="viewerImg" src="" alt="Preview" style="max-width:90%;max-height:90%;border-radius:10px;">
    <button id="closeViewer" style="position:absolute;top:20px;right:30px;background:none;border:none;color:#fff;font-size:2rem;cursor:pointer;">&times;</button>
  </div>

  <!-- ======= JS SECTION ======= -->
  <script>
    // ✅ FIXED: Add missing getCookie()
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          cookie = cookie.trim();
          if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    async function fetchPendingRequests() {
      try {
        const response = await fetch("{% url 'pending_requests_api' %}");
        const data = await response.json();
        const list = document.getElementById('pendingList');
        list.innerHTML = data.html || '<li class="pending-item">No pending requests</li>';
        attachClickEvents();
      } catch (err) {
        console.error(err);
      }
    }

    function attachClickEvents() {
      document.querySelectorAll('#pendingList .pending-item').forEach(item => {
        const id = item.dataset.id;
        item.onclick = async () => {
          const res = await fetch(`/api/reservation_detail/${id}/`);
          const data = await res.json();
          document.getElementById('modalTitle').innerText = data.item?.name ?? '';
          document.getElementById('modalPriority').innerText = data.priority_display ?? '';
          document.getElementById('modalBorrower').innerText = data.userborrower?.full_name ?? '';
          document.getElementById('modalQty').innerText = data.quantity ?? '';
          document.getElementById('modalDate').innerText = data.date_borrowed ?? '';
          document.getElementById('modalMessage').innerText = data.message ?? '';
          document.getElementById('modalContact').innerText = data.contact_number ?? '';
          document.getElementById('modalStatus').innerText = data.status ?? '';
          document.getElementById('modalLetter').src = data.letter_image ?? '';
          document.getElementById('modalID').src = data.valid_id_image ?? '';
          document.getElementById('reservationModal').style.display = 'flex';

          document.getElementById('approveBtn').onclick = () => updateReservation(id, 'approved');

          document.getElementById('declineBtn').onclick = () => {
            document.getElementById('declineModal').style.display = 'flex';
            document.getElementById('submitDecline').onclick = () => {
              const reason = document.getElementById('declineReason').value.trim();
              if (!reason) return alert('Please enter a reason.');
              updateReservation(id, 'rejected', reason);
              document.getElementById('declineModal').style.display = 'none';
              document.getElementById('declineReason').value = '';
            };
          };
        };
      });
    }

    document.getElementById('closeModal').onclick = () => {
      document.getElementById('reservationModal').style.display = 'none';
    };
    document.getElementById('cancelDecline').onclick = () => {
      document.getElementById('declineModal').style.display = 'none';
    };
    document.getElementById('closeViewer').onclick = () => {
      document.getElementById('imageViewer').style.display = 'none';
    };

    document.getElementById('modalLetter').onclick = (e) => {
      document.getElementById('viewerImg').src = e.target.src;
      document.getElementById('imageViewer').style.display = 'flex';
    };
    document.getElementById('modalID').onclick = (e) => {
      document.getElementById('viewerImg').src = e.target.src;
      document.getElementById('imageViewer').style.display = 'flex';
    };

    async function updateReservation(id, status, reason = null) {
      const payload = { status };
      if (reason) payload.reason = reason;
      const res = await fetch(`/api/reservation_update/${id}/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      if (data.status === 'success') {
        showToast(`Reservation ${status} successfully `, "success");
        document.getElementById('reservationModal').style.display = 'none';
        fetchPendingRequests();
        
      } else {
        showToast(data.message || 'Failed to update reservation', "error");
        
      }
    }

    fetchPendingRequests();
    setInterval(fetchPendingRequests, 10000);
  </script>

  <script>
  window.addEventListener("load", function() {
  const content = document.querySelector(".content");
  const pendingPanel = document.querySelector(".pending-container");

  if (!content) return;

  // Determine if we're on Dashboard page
  const isDashboard = window.location.pathname.includes("dashboard");

  // Hide or show panel based on page
  if (!isDashboard) {
    if (pendingPanel) pendingPanel.style.display = "none";
    content.classList.add("fullwidth");
  } else {
    content.classList.remove("fullwidth");
  }

  document.body.classList.add("ready");
});
</script>

<!-- Toast Notification Container -->
<div id="toast-container"
     style="position:fixed; top:20px; right:20px; z-index:9999; display:flex; flex-direction:column; gap:10px;">
</div>


<script>
function showToast(message, type = "success") {
  const container = document.getElementById("toast-container");
 

  // Create toast element
  const toast = document.createElement("div");
  toast.textContent = message;
  toast.style.padding = "12px 18px";
  toast.style.borderRadius = "8px";
  toast.style.color = "#fff";
  toast.style.fontSize = "0.9rem";
  toast.style.fontWeight = "500";
  toast.style.boxShadow = "0 3px 8px rgba(0,0,0,0.25)";
  toast.style.opacity = "0";
  toast.style.transform = "translateX(100%)";
  toast.style.transition = "opacity 0.4s ease, transform 0.4s ease";
  toast.style.willChange = "opacity, transform";
  
  // Colors
  if (type === "success") toast.style.background = "#2ecc71";
  else if (type === "error") toast.style.background = "#e74c3c";
  else if (type === "info") toast.style.background = "#3498db";
  else toast.style.background = "#444";

  container.appendChild(toast);

  // Animate in
  requestAnimationFrame(() => {
    toast.style.opacity = "1";
    toast.style.transform = "translateX(0)";
  });

  // Auto remove after 3.5s
  setTimeout(() => {
    toast.style.opacity = "0";
    toast.style.transform = "translateX(100%)";
    setTimeout(() => toast.remove(), 400);
  }, 3500);
}

async function updatePendingCount() {
  try {
    const response = await fetch("{% url 'pending_requests_api' %}");
    const data = await response.json();
    const tempDiv = document.createElement("div");
    tempDiv.innerHTML = data.html || "";

    // Count list items (pending requests)
    const count = tempDiv.querySelectorAll("li.pending-item").length;

    const badge = document.getElementById("notifCount");
    if (count > 0) {
      badge.textContent = count;
      badge.style.display = "inline";
    } else {
      badge.style.display = "none";
    }
  } catch (e) {
    console.error("Error fetching pending count:", e);
  }
}

// 🔁 Update every 10 seconds
updatePendingCount();
setInterval(updatePendingCount, 10000);

// Toggle panel when clicking the bell
function togglePendingPanel() {
  const panel = document.querySelector(".pending-container");
  if (!panel) return;
  const isVisible = panel.style.display !== "none";
  panel.style.display = isVisible ? "none" : "block";
}
</script>
</body>
</html>
